/**
 * Create and save fingerprints as image and print their reference in the current stream.
 *
 * @param performanceResults The performance results used to print the fingerprints
 */
public void print(final PerformanceResults performanceResults) {
	String buildName = performanceResults.getName();

	// Compute fingerprint output file name prefix
	int currentUnderscoreIndex = buildName.indexOf('_');
	if  (currentUnderscoreIndex != -1){
		buildName = buildName.substring(0, currentUnderscoreIndex);
	}
	StringBuffer buffer = new StringBuffer("FP_");
	if (this.component != null) {
		buffer.append(this.component);
		buffer.append('_');
	}
	buffer.append(DB_Results.getDbBaselineRefVersion());
	buffer.append('_');
	buffer.append(buildName);
	String filePrefix = buffer.toString();

	// Print the legend
	this.stream.print("The following fingerprints show results for the most representative tests of the ");
	if (this.component == null) {
		this.stream.print("current build.<br>\n");
	} else {
		this.stream.print(this.component);
		this.stream.print(" component.<br>\n");
	}
	this.stream.print("<table border=\"0\">\n");
	this.stream.print("<tr><td valign=\"top\">Select which kind of scale you want to use:</td>\n");
	this.stream.print("<td valign=\"top\">\n");
	this.stream.print("  <form>\n");
	this.stream.print("    <select onChange=\"toggleFingerprints();\">\n");
	this.stream.print("      <option>percentage</option>\n");
	this.stream.print("      <option>time (linear)</option>\n");
	this.stream.print("      <option>time (log)</option>\n");
	this.stream.print("    </select>\n");
	this.stream.print("  </form>\n");
	this.stream.print("</td>\n");
//	this.stream.print("<td valign=\"top\">\n");
//	this.stream.print("<a href=\"help.html\"><img hspace=\"10\" border=\"0\" src=\""+Utils.LIGHT+"\" title=\"Some tips on fingerprints\"/></a>\n");
//	this.stream.print("</td></tr></table>\n");
	this.stream.print("</tr></table>\n");
	this.stream.print("<img hspace=\"10\" border=\"0\" src=\""+Utils.LIGHT+"\"><a href=\""+Utils.HELP+"\">Help on fingerprints</a>\n");

	// Print script to reset dropdown list selection
	this.stream.print("<script type=\"text/javascript\">\n");
	this.stream.print("	setFingerprintsType();\n");
	this.stream.print("</script>\n");

	// Create each fingerprint and save it
	String[] configNames = performanceResults.getConfigNames(false/* not sorted*/);
	String[] configBoxes = performanceResults.getConfigBoxes(false/* not sorted*/);
	int length = configNames.length;
	for (int c=0; c<length; c++) {
		String configName  = configNames[c];
		List scenarios = performanceResults.getComponentSummaryScenarios(this.component, configName);
		if (scenarios == null) continue;

		// Create BarGraph
		// TODO use FingerPrintGraph instead
		BarGraph barGraph = null;
		List allResults = new ArrayList();
		String defaultDimName = DB_Results.getDefaultDimension().getName();
		for (int i=0, size=scenarios.size(); i<size; i++) {
			ScenarioResults scenarioResults = (ScenarioResults) scenarios.get(i);
			ConfigResults configResults = scenarioResults.getConfigResults(configName);
			if (configResults == null || !configResults.isValid()) continue;
			double[] results = configResults.getCurrentBuildDeltaInfo();
			double percent = -results[0] * 100.0;
			if (results != null && Math.abs(percent) < 200) {
				String name = scenarioResults.getLabel() + " (" + defaultDimName + ")";
				if (!configResults.getCurrentBuildName().equals(buildName)) {
					continue; // the test didn't run on last build, skip it
				}
				if (!configResults.isBaselined()) {
					name = "*" + name + " (" + configResults.getBaselineBuildName() + ")";
				}
				if (barGraph == null) {
					barGraph = new BarGraph(null);
				}
				barGraph.addItem(name,
				    results,
				    configName + "/" + scenarioResults.getFileName() + ".html",
				    configResults.getCurrentBuildResults().getComment(),
				    (Utils.confidenceLevel(results) & Utils.ERR) == 0);

				// add results
				allResults.add(configResults);
			}
		}
		if (barGraph == null) continue;

		// Save image file
		String fileName = filePrefix + '.' + configName ;
		File outputFile = new File(this.outputDir, fileName+".gif");
		save(barGraph, outputFile);

		// Print image file reference in stream
		String boxName = configBoxes[c];
		if (outputFile.exists()) {
			String areas = barGraph.getAreas();
			if (areas == null) areas = "";
			this.stream.print("<h4>");
			this.stream.print(boxName);
			this.stream.print("</h4>\n");
			this.stream.print("<?php\n");
			this.stream.print("	$type=$_SERVER['QUERY_STRING'];\n");
			this.stream.print("	if ($type==\"\" || $type==\"fp_type=0\") {\n");
			this.stream.print("		echo '<img src=\"");
			this.stream.print(fileName);
			this.stream.print(".gif\" usemap=\"#");
			this.stream.print(fileName);
			this.stream.print("\" name=\"");
			this.stream.print(configName);
			this.stream.print("\">';\n");
			this.stream.print("		echo '<map name=\"");
			this.stream.print(fileName);
			this.stream.print("\">';\n");
			this.stream.print(areas);
			this.stream.print("		echo '</map>';\n");
			this.stream.print("	}\n");
		} else {
			this.stream.print("<br><br>There is no fingerprint for ");
			this.stream.print(boxName);
			this.stream.print("<br><br>\n");
		}

		// Create, paint and print the time bars graph
		FingerPrintGraph graph = new FingerPrintGraph(this.outputDir, fileName, GRAPH_WIDTH, allResults);
		graph.paint(this.stream);
		this.stream.print("?>\n");
	}
}

