	/*
	 * @see org.eclipse.jdt.internal.ui.actions.BlockCommentAction#runInternal(org.eclipse.jface.text.ITextSelection, org.eclipse.jface.text.IDocumentExtension3, org.eclipse.jdt.internal.ui.actions.BlockCommentAction.Edit.EditFactory)
	 */
	protected void runInternal(ITextSelection selection, IDocumentExtension3 docExtension, Edit.EditFactory factory) throws BadLocationException, BadPartitioningException {
		int selectionOffset = selection.getOffset();
		int selectionEndOffset = selectionOffset + selection.getLength();
		List edits = new LinkedList();

		if (docExtension instanceof IStructuredDocument) {
			IStructuredDocument sDoc = (IStructuredDocument) docExtension;
			IStructuredDocumentRegion sdRegion = sDoc.getRegionAtCharacterOffset(selectionOffset);
			ITextRegion textRegion = sdRegion.getRegionAtCharacterOffset(selectionOffset);
			
			ITextRegionCollection container = sdRegion;
			
			if(textRegion instanceof ITextRegionContainer){
				container = (ITextRegionContainer)textRegion;
				textRegion = container.getRegionAtCharacterOffset(selectionOffset);
			}

			if (textRegion.getType() == PHPRegionContext.PHP_CONTENT) {
				PhpScriptRegion phpScriptRegion = (PhpScriptRegion) textRegion;
				ITypedRegion partition = PHPPartitionTypes.getPartition(phpScriptRegion, selectionOffset - container.getStartOffset() - phpScriptRegion.getStart());

				int phpRegionStart = container.getStartOffset(phpScriptRegion);

				handleFirstPartition(partition, edits, factory, selectionOffset, phpRegionStart);

				ITypedRegion lastPartition = partition;
				while (partition != null && phpRegionStart + partition.getOffset() + partition.getLength() < selectionEndOffset) {
					lastPartition = partition;
					partition = handleInteriorPartition(partition, edits, factory, docExtension, phpRegionStart);
				}
				if(partition == null){
					partition = lastPartition;
				}
				handleLastPartition(partition, edits, factory, selectionEndOffset, phpRegionStart);
			}
		}

		executeEdits(edits);
	}

