	/*
	 * @see org.eclipse.jdt.internal.ui.actions.AddBlockCommentAction#runInternal(org.eclipse.jface.text.ITextSelection, org.eclipse.jface.text.IDocumentExtension3, org.eclipse.jdt.internal.ui.actions.AddBlockCommentAction.Edit.EditFactory)
	 */
	protected void runInternal(ITextSelection selection, IDocumentExtension3 docExtension, Edit.EditFactory factory) throws BadPartitioningException, BadLocationException {
		List edits = new LinkedList();
		int offset = selection.getOffset();
		int endOffset = offset + selection.getLength();
		if (!(docExtension instanceof IStructuredDocument)) {
			return;
		}
		do {

			IStructuredDocument sDoc = (IStructuredDocument) docExtension;
			IStructuredDocumentRegion sdRegion = sDoc.getRegionAtCharacterOffset(offset);
			ITextRegion textRegion = sdRegion.getRegionAtCharacterOffset(offset);

			ITextRegionCollection container = sdRegion;

			if (textRegion instanceof ITextRegionContainer) {
				container = (ITextRegionContainer) textRegion;
				textRegion = container.getRegionAtCharacterOffset(offset);
			}

			if (textRegion.getType() == PHPRegionContext.PHP_CONTENT) {
				PhpScriptRegion phpScriptRegion = (PhpScriptRegion) textRegion;
				textRegion = phpScriptRegion.getPhpToken(offset - container.getStartOffset() - phpScriptRegion.getStart());
				if (PHPPartitionTypes.isPHPMultiLineCommentState(textRegion.getType())) {
					ITextRegion startRegion = PHPPartitionTypes.getPartitionStartRegion(phpScriptRegion, textRegion.getStart());
					ITextRegion endRegion = PHPPartitionTypes.getPartitionEndRegion(phpScriptRegion, textRegion.getStart());
					if (startRegion.getType() == PHPRegionTypes.PHP_COMMENT_START && endRegion.getType() == PHPRegionTypes.PHP_COMMENT_END) {
						int startCommentOffset = container.getStart() + phpScriptRegion.getStart() + startRegion.getStart();
						int endCommentOffset = container.getStart() + phpScriptRegion.getStart() + endRegion.getStart();
						edits.add(factory.createEdit(startCommentOffset, startRegion.getLength(), "")); //$NON-NLS-1$
						edits.add(factory.createEdit(endCommentOffset, getCommentEnd().length(), "")); //$NON-NLS-1$
						offset = endCommentOffset + endRegion.getLength();
					} else {
						break; // comment is not opened or not closed
					}
				} else {
					int endPartitionOffset = PHPPartitionTypes.getPartitionStart(phpScriptRegion, offset - container.getStartOffset() - phpScriptRegion.getStart());
					offset = container.getStart() + phpScriptRegion.getStart() + endPartitionOffset;
				}
			} else {
				break;
			}
		} while (offset < endOffset);

		executeEdits(edits);
	}

