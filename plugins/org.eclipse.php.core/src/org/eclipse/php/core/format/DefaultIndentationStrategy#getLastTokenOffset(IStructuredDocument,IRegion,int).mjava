	protected int getLastTokenOffset(final IStructuredDocument document, final IRegion line, final int forOffset) {

		final int startOffset = line.getOffset();
		IStructuredDocumentRegion sdRegion = document.getRegionAtCharacterOffset(forOffset);
		int regionStartOffset = sdRegion.getStartOffset();
		int offset = forOffset;
		while (startOffset <= offset) {
			if (document.getLength() == offset) {//if we are at the end of the document then we need to check one step before
				offset--;
				continue;
			}
			ITextRegion tRegion = sdRegion.getRegionAtCharacterOffset(offset);
			if (tRegion == null) {
				sdRegion = sdRegion.getPrevious();
				if (sdRegion != null) {
					regionStartOffset = sdRegion.getStartOffset();
					tRegion = sdRegion.getLastRegion();
					offset = tRegion.getStart() + regionStartOffset - 1;
					continue;
				}
				return -1;
			}
			if (tRegion.getStart() + regionStartOffset < startOffset)
				//if the tRegion started before the line was then the first char in this line was a whitespace 
				return -1;
			if (tRegion.getTextEnd() + regionStartOffset > forOffset) {
				offset = tRegion.getStart() + regionStartOffset - 1;
				continue;
			}
			if (!PhpLexer.isPHPCommentState(tRegion.getType()) && tRegion.getType() != PHPRegionTypes.WHITESPACE)
				return sdRegion.getStartOffset(tRegion);
			offset = tRegion.getStart() + regionStartOffset - 1;
		}
		return -1;
	}

