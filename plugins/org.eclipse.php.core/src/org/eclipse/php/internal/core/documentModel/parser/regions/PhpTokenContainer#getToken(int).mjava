	/**
	 * find token for a given location
	 * 
	 * @param offset
	 * @return
	 * @throws BadLocationException
	 *             - if the offset is out of bound
	 */
	public synchronized ITextRegion getToken(int offset)
			throws BadLocationException {
		assert tokensIterator != null;
		if (phpTokens.isEmpty()) {
			return null;
		}

		// we have at least one region...
		checkBadLocation(offset);

		// smart searching
		ITextRegion result = tokensIterator.hasNext() ? tokensIterator.next()
				: tokensIterator.previous();
		ITextRegion oldResult = result;
		if (isInside(result, offset)) {
			return result;
		}

		if (result != null && offset >= result.getEnd()) { // if the offset is
															// beyond - go fetch
			// from next
			while (tokensIterator.hasNext() && !isInside(result, offset)) {
				if (result == null) {
					return oldResult;
				} else {
					oldResult = result;
				}
				result = tokensIterator.next();

			}
		} else { // else go fetch from previous
			while (tokensIterator.hasPrevious() && !isInside(result, offset)) {
				if (result == null) {
					return oldResult;
				} else {
					oldResult = result;
				}
				result = tokensIterator.previous();
			}
			// moves the iterator to the next one
			if (tokensIterator.hasNext()) {
				tokensIterator.next();
			}
		}

		return result;
	}

