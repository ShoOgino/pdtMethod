	/**
	 * This method searches in the project scope for all elements of specified type that match the given prefix.
	 * If the project doesn't exist, workspace scope is used.
	 * 
	 * @param sourceModule Current file
	 * @param scope Search scope
	 * @param prefix Element name or prefix
	 * @param exactName Whether the prefix is an exact name of the element
	 * @param elementType Element type from {@link IDLTKSearchConstants}
	 * @param currentFileOnly Whether to look in current file only
	 * @param caseSensitive Whether the search is case sensitive
	 * @return
	 */
	private static IModelElement[] getGlobalElements(ISourceModule sourceModule, IDLTKSearchScope scope, String prefix, boolean exactName, final int elementType, boolean currentFileOnly, boolean caseSensitive) {

		IDLTKLanguageToolkit toolkit = PHPLanguageToolkit.getDefault();

		int matchRule;
		if (prefix.length() == 0 && !exactName) {
			prefix = WILDCARD;
			matchRule = SearchPattern.R_PATTERN_MATCH;
			if (caseSensitive) {
				matchRule |= SearchPattern.R_CASE_SENSITIVE;
			}
		} else {
			if (caseSensitive) {
				matchRule = exactName ? SearchPattern.R_EXACT_MATCH : SearchPattern.R_PREFIX_MATCH;
				matchRule |= SearchPattern.R_CASE_SENSITIVE;
			} else {
				matchRule = exactName ? SearchPattern.R_EXACT_MATCH : SearchPattern.R_CAMELCASE_MATCH | SearchPattern.R_PREFIX_MATCH;
			}
		}

		SearchEngine searchEngine = new SearchEngine();
		SearchPattern pattern = SearchPattern.createPattern(prefix, elementType, IDLTKSearchConstants.DECLARATIONS, matchRule, toolkit);

		final Set<IModelElement> elements = new TreeSet<IModelElement>(new AlphabeticComparator(sourceModule));
		
		final List<String> namespaceNames = new LinkedList<String>();
		if (elementType == IDLTKSearchConstants.TYPE) {
			PHPMixinModel mixinModel = PHPMixinModel.getInstance(sourceModule.getScriptProject());
			IModelElement[] namespaces = mixinModel.getNamespace(prefix + WILDCARD, scope);
			for (IModelElement namespace : namespaces) {
				namespaceNames.add(((NamespaceType)namespace).getElementName());
				elements.add(namespace);
			}
		}
		
		try {
			searchEngine.search(pattern, new SearchParticipant[] { SearchEngine.getDefaultSearchParticipant() }, scope, new SearchRequestor() {
				public void acceptSearchMatch(SearchMatch match) throws CoreException {

					IModelElement element = (IModelElement) match.getElement();
					if (namespaceNames.size() > 0) {
						for (String namespaceName : namespaceNames) {
							if (element.getElementName().startsWith(namespaceName + '_')) {
								return;
							}
						}
					}

					// sometimes method reference is found instead of declaration (seems to be a bug in search engine):
					if (element instanceof SourceModule) {
						return;
					}

					IModelElement parent = element.getParent();

					// Global scope elements in PHP are those, which are not defined in class body,
					// or it is a variable, and its parent - source module
					if ((element instanceof IField && parent instanceof org.eclipse.dltk.core.ISourceModule) || (!(element instanceof IField) && !(parent instanceof IType))) {
						elements.add(element);
					}
				}
			}, null);
		} catch (CoreException e) {
			if (DLTKCore.DEBUG_COMPLETION) {
				e.printStackTrace();
			}
		}

		IModelElement[] result = elements.toArray(new IModelElement[elements.size()]);
		return currentFileOnly ? result : PHPModelUtils.filterElements(sourceModule, result);
	}

