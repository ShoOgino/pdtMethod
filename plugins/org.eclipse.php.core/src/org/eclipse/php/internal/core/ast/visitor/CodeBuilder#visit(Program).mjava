	public void visit(Program program) {
		boolean isPhpState = false;
		Statement[] statements = program.getStatements();
		for (int i = 0; i < statements.length; i++) {
			boolean isHtml = statements[i] instanceof InLineHtml;

			if (!isHtml && !isPhpState) {
				// html -> php
				buffer.append("<?php\n");
				statements[i].accept(this);
				isPhpState = true;
			} else if (!isHtml && isPhpState) {
				// php -> php
				statements[i].accept(this);
				buffer.append("\n");
			} else if (isHtml && isPhpState) {
				// php -> html
				buffer.append("?>\n");
				statements[i].accept(this);
				buffer.append("\n");
				isPhpState = false;
			} else {
				// html first
				statements[i].accept(this);
				buffer.append("\n");
			}
		}

		if (isPhpState) {
			buffer.append("?>\n");
		}

		Collection comments = program.getComments();
		for (Iterator iter = comments.iterator(); iter.hasNext();) {
			Comment comment = (Comment) iter.next();
			comment.accept(this);
		}
	}

