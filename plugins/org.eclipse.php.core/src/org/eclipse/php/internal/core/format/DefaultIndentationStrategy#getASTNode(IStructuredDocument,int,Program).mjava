	public static ASTNode getASTNode(final IStructuredDocument document,
			final int offset, Program program) throws BadLocationException {
		try {
			IRegion lineInfo = document.getLineInformationOfOffset(offset);
			int lineStart = lineInfo.getOffset();
			while (Character.isWhitespace(document.getChar(lineStart))
					&& (lineStart < document.getLength() - 1))
				lineStart++;
			if (program == null) {
				program = getProgram(document);
			}
			if (program == null || lineStart > program.getEnd()
					|| offset > program.getEnd()) {
				return null;
			}
			if (lineStart < offset
					|| lineStart > (lineInfo.getOffset() + lineInfo.getLength())) {
				lineStart = offset;
			}
			ASTNode node = getIndentationBaseNode(program, document, lineStart);
			if (node == program) {
				return null;
			}
			return node;
		} catch (Exception e) {
			PHPCorePlugin.log(e);
		}
		return null;
	}

