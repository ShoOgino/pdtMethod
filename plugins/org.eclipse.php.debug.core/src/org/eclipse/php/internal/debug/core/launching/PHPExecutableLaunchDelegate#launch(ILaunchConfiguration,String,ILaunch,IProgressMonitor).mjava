	public void launch(final ILaunchConfiguration configuration, final String mode, final ILaunch launch, final IProgressMonitor monitor) throws CoreException {
		if (!PHPLaunchUtilities.notifyPreviousLaunches(launch)) {
			monitor.setCanceled(true);
			monitor.done();
			return;
		}
		PHPLaunchUtilities.showDebugView();
		IProgressMonitor subMonitor; // the total of monitor is 100
		if (monitor.isCanceled())
			return;

		final String phpExeString = configuration.getAttribute(PHPCoreConstants.ATTR_LOCATION, (String) null);
		final String projectName = configuration.getAttribute(PHPCoreConstants.ATTR_WORKING_DIRECTORY, (String) null);
		final String fileNameString = configuration.getAttribute(PHPCoreConstants.ATTR_FILE, (String) null);
		final boolean runWithDebugInfo = configuration.getAttribute(IPHPConstants.RUN_WITH_DEBUG_INFO, true);

		if (monitor.isCanceled())
			return;

		if (fileNameString == null || fileNameString.equals(""))
			return;

		final IWorkspaceRoot workspaceRoot = ResourcesPlugin.getWorkspace().getRoot();
		final IPath filePath = new Path(fileNameString);
		IProject project = null;
		IProject dummyProject = null;
		String absolutePath = null;
		if (projectName == null) {
			IResource res = workspaceRoot.findMember(filePath);
			if (res == null && filePath.getDevice() != null) {
				// Get a dummy project because we are probably executing a file that is located out
				// of the workspace.
				dummyProject = PHPWorkspaceModelManager.getDefaultPHPProjectModel().getProject();
				project = dummyProject;
				absolutePath = filePath.makeAbsolute().toString();
			} else {
				if (res == null || !res.isAccessible()) {
					displayErrorMessage(NLS.bind(PHPDebugCoreMessages.Debugger_ResourceNotFound, filePath));
					return;
				}
			}
			if (project == null) {
				project = res.getProject();
				absolutePath = res.getLocation().toString();
			}
			if (project == null) {
				displayErrorMessage(NLS.bind(PHPDebugCoreMessages.Debugger_InvalidDebugResource, filePath));
				return;
			}
		} else {
			try {
				final IPath projectPath = new Path(projectName);
				project = workspaceRoot.getProject(projectPath.lastSegment());
				absolutePath = filePath.makeAbsolute().toString();
			} catch (final Exception e) {
			}
		}

		if (project == null || (!project.isAccessible() && project != dummyProject)) {
			displayErrorMessage(NLS.bind(PHPDebugCoreMessages.Debugger_InvalidDebugResource, filePath));
			return;
		}

		subMonitor = new SubProgressMonitor(monitor, 10); // 10 of 100
		//		if (!saveFiles(project, monitor)) {
		//			return;
		//		}
		File phpIni = IniModifier.findPHPIni(phpExeString);
		if (project != dummyProject) {
			if (phpIni != null) {
				File tempIni = IniModifier.addIncludePath(phpIni, project);
				if (tempIni != null) {
					launch.setAttribute(IDebugParametersKeys.PHP_INI_LOCATION, tempIni.getAbsolutePath());
				}
			}
		} else {
			launch.setAttribute(IDebugParametersKeys.PHP_INI_LOCATION, phpIni.getAbsolutePath());
		}

		if (mode.equals(ILaunchManager.DEBUG_MODE) || runWithDebugInfo == true) {
			boolean stopAtFirstLine = false;
			if (configuration.getAttribute(IDebugParametersKeys.OVERRIDE_FIRST_LINE_BREAKPOINT, false)) {
				stopAtFirstLine = configuration.getAttribute(IDebugParametersKeys.FIRST_LINE_BREAKPOINT, false);
			} else {
				stopAtFirstLine = PHPProjectPreferences.getStopAtFirstLine(project);
			}
			final int requestPort = PHPProjectPreferences.getDebugPort(project);

			// Set Project Name
			final String projectString = project.getFullPath().toString();

			ILaunchConfigurationWorkingCopy wc;
			if (configuration.isWorkingCopy())
				wc = (ILaunchConfigurationWorkingCopy) configuration;
			else
				wc = configuration.getWorkingCopy();
			wc.setAttribute(IPHPConstants.PHP_Project, projectString);

			// Set transfer encoding:
			wc.setAttribute(IDebugParametersKeys.TRANSFER_ENCODING, PHPProjectPreferences.getTransferEncoding(project));
			wc.setAttribute(IDebugParametersKeys.OUTPUT_ENCODING, PHPProjectPreferences.getOutputEncoding(project));
			wc.doSave();

			if (monitor.isCanceled())
				return;

			// Generate a session id for this launch and put it in the map
			final int sessionID = DebugSessionIdGenerator.generateSessionID();
			PHPSessionLaunchMapper.put(sessionID, launch);

			// Define all needed debug attributes:
			launch.setAttribute(IDebugParametersKeys.PORT, Integer.toString(requestPort));
			launch.setAttribute(IDebugParametersKeys.FIRST_LINE_BREAKPOINT, Boolean.toString(stopAtFirstLine));
			launch.setAttribute(IDebugParametersKeys.SESSION_ID, Integer.toString(sessionID));

			// Trigger the debug session by initiating a debug requset to the php.exe
			debugPHPExecutable(launch, phpExeString, absolutePath);
		} else {
			// resolve location
			final IPath phpExe = new Path(phpExeString);

			if (monitor.isCanceled())
				return;

			// resolve working directory
			//            String projectFolderString = configuration.getAttribute(PHPCoreConstants.ATTR_WORKING_DIRECTORY, (String)null);

			IPath projectLocation = project.getRawLocation();
			if (projectLocation == null)
				projectLocation = project.getLocation();

			if (monitor.isCanceled())
				return;

			//            String fileNameString = configuration.getAttribute(PHPCoreConstants.ATTR_FILE, (String)null);
			IPath phpFile = new Path(fileNameString);
			if (fileNameString.startsWith("/"))
				phpFile = phpFile.removeFirstSegments(1);

			if (monitor.isCanceled())
				return;

			final String[] envp = DebugPlugin.getDefault().getLaunchManager().getEnvironment(configuration);

			if (monitor.isCanceled())
				return;

			File workingDir = new File(phpExe.removeLastSegments(1).toString());
			String phpConfigDir = workingDir.getAbsolutePath();

			String phpIniLocation = launch.getAttribute(IDebugParametersKeys.PHP_INI_LOCATION);
			if (phpIniLocation != null && !phpIniLocation.equals("")) {
				phpConfigDir = phpIniLocation;
			}
			final IResource res = workspaceRoot.findMember(filePath);
			String fileName = null;
			if (res != null) {
				fileName = res.getLocation().toOSString();
			} else {
				fileName = filePath.toOSString();
			}
			final String[] cmdLine = new String[] { phpExe.toOSString(), "-c", phpConfigDir, fileName };

			final Process p = DebugPlugin.exec(cmdLine, workingDir, envp);
			IProcess process = null;

			// add process type to process attributes
			final Map processAttributes = new HashMap();
			String programName = phpExe.lastSegment();
			final String extension = phpExe.getFileExtension();
			if (extension != null)
				programName = programName.substring(0, programName.length() - (extension.length() + 1));
			programName = programName.toLowerCase();
			processAttributes.put(IProcess.ATTR_PROCESS_TYPE, programName);

			if (p != null) {
				subMonitor = new SubProgressMonitor(monitor, 80); // 10+80 of 100;
				subMonitor.beginTask(MessageFormat.format("start launch", new String[] { configuration.getName() }), IProgressMonitor.UNKNOWN); //$NON-NLS-1$
				process = DebugPlugin.newProcess(launch, p, phpExe.toOSString(), processAttributes);
				if (process == null) {
					p.destroy();
					throw new CoreException(new Status(IStatus.ERROR, PHPDebugPlugin.getID(), 0, null, null));
				}
				subMonitor.done();

			}
			process.setAttribute(IProcess.ATTR_CMDLINE, fileNameString);

			if (CommonTab.isLaunchInBackground(configuration)) {
				// refresh resources after process finishes
				/*
				 if (RefreshTab.getRefreshScope(configuration) != null) {
				 BackgroundResourceRefresher refresher = new BackgroundResourceRefresher(configuration, process);
				 refresher.startBackgroundRefresh();
				 }               
				 */
			} else {
				// wait for process to exit
				while (!process.isTerminated())
					try {
						if (monitor.isCanceled()) {
							process.terminate();
							break;
						}
						Thread.sleep(50);
					} catch (final InterruptedException e) {
					}

				// refresh resources
				subMonitor = new SubProgressMonitor(monitor, 10); // 10+80+10 of 100;
				RefreshTab.refreshResources(configuration, subMonitor);
			}
		}

	}

